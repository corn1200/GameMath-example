# 게임 수학 정리 문서
게임 개발에 필요한 수학 개념에 대해 정리한 문서입니다.

# 목차
* [1. 수와 집합](README-ORIGIN.md#1-수와-집합)
    * [1.1. 연산과 수의 구조](README-ORIGIN.md#11-연산과-수의-구조)
    * [1.2. 수의 구조](README-ORIGIN.md#12-수의-구조)
    * [1.3. 수의 표현](README-ORIGIN.md#13-수의-표현)
* [2. 함수](README-ORIGIN.md#2-함수)
    * [2.1. 함수의 개념과 종류](README-ORIGIN.md#21-함수의-개념과-종류)
    * [2.2. 합성함수](README-ORIGIN.md#22-합성함수)
    * [2.3. 항등함수와 역함수](README-ORIGIN.md#23-항등함수와-역함수)
    * [2.4. 곱집합을 활용한 좌표 평면으로의 확장](README-ORIGIN.md#24-곱집합을-활용한-좌표-평면으로의-확장)
* [3. 데카르트 좌표계](README-ORIGIN.md#3-데카르트-좌표계)
* [4. 벡터 공간과 벡터](README-ORIGIN.md#4-벡터-공간과-벡터)
    * [4.1. 스칼라와 벡터](README-ORIGIN.md#41-스칼라와-벡터)
    * [4.2. 벡터 공간의 연산](README-ORIGIN.md#42-벡터-공간의-연산)
    * [4.3. 벡터의 크기와 이동](README-ORIGIN.md#43-벡터의-크기와-이동)
* [5. 벡터의 결합과 생성](README-ORIGIN.md#5-벡터의-결합과-생성)
* [6. 삼각함수](README-ORIGIN.md#6-삼각함수)
    * [6.1. 삼각함수의 성질](README-ORIGIN.md#61-삼각함수의-성질)
    * [6.2. 각의 측정법](README-ORIGIN.md#62-각의-측정법)
* [7. 삼각함수를 활용한 물체의 회전](README-ORIGIN.md#7-삼각함수를-활용한-물체의-회전)
* [8. 삼각함수의 역함수](README-ORIGIN.md#8-삼각함수의-역함수)
* [9. 극좌표계](README-ORIGIN.md#9-극좌표계)
* [10. 선형성: 예측 가능한 비례 관계](README-ORIGIN.md#10-선형성-예측-가능한-비례-관계)
    * [10.1. 선형 함수](README-ORIGIN.md#101-선형-함수)
    * [10.2. 벡터 공간의 선형 변환](README-ORIGIN.md#102-벡터-공간의-선형-변환)
* [11. 행렬](README-ORIGIN.md#11-행렬)
    * [11.1. 행렬의 기본 연산](README-ORIGIN.md#111-행렬의-기본-연산)
    * [11.2. 행렬의 곱셈](README-ORIGIN.md#112-행렬의-곱셈)
    * [11.3. 정방행렬의 곱셈](README-ORIGIN.md#113-정방행렬의-곱셈)
* [12. 행렬의 설계](README-ORIGIN.md#12-행렬의-설계)
    * [12.1. 크기 변환행렬](README-ORIGIN.md#121-크기-변환행렬)
    * [12.2. 회전 변환행렬](README-ORIGIN.md#122-회전-변환행렬)
    * [12.3. 전단 변환행렬](README-ORIGIN.md#123-전단-변환행렬)
    * [12.4. 삼각함수의 덧셈 정리](README-ORIGIN.md#124-삼각함수의-덧셈-정리)
* [13. 역행렬](README-ORIGIN.md#13-역행렬)
    * [13.1. 역행렬의 존재를 판별하는 행렬식](README-ORIGIN.md#131-역행렬의-존재를-판별하는-행렬식)
    * [13.2. 크기 변환행렬의 역행렬](README-ORIGIN.md#132-크기-변환행렬의-역행렬)
    * [13.3. 전단 변환행렬의 역행렬](README-ORIGIN.md#133-전단-변환행렬의-역행렬)
    * [13.4. 회전 변환행렬의 역행렬](README-ORIGIN.md#134-회전-변환행렬의-역행렬)
    * [13.5. 행렬 곱의 역행렬](README-ORIGIN.md#135-행렬-곱의-역행렬)
* [14. 이동 변환을 위한 아핀 공간](README-ORIGIN.md#14-이동-변환을-위한-아핀-공간)
* [15. 아핀 공간의 구성 요소](README-ORIGIN.md#15-아핀-공간의-구성-요소)
    * [15.1. 점](README-ORIGIN.md#151-점)
    * [15.2. 이동 벡터](README-ORIGIN.md#152-이동-벡터)
    * [15.3. 아핀 공간의 성질](README-ORIGIN.md#153-아핀-공간의-성질)
* [16. 아핀 결합](README-ORIGIN.md#16-아핀-결합)
    * [16.1. 두 점의 결합](README-ORIGIN.md#161-두-점의-결합)
* [17. 벡터의 내적](README-ORIGIN.md#17-벡터의-내적)
    * [17.1. 내적의 성질](README-ORIGIN.md#171-내적의-성질)
    * [17.2. 내적과 삼각함수의 관계](README-ORIGIN.md#172-내적과-삼각함수의-관계)
    * [17.3. 행렬의 곱셈을 내적으로 표현하기](README-ORIGIN.md#173-행렬의-곱셈을-내적으로-표현하기)
* [18. 시야 판별](README-ORIGIN.md#18-시야-판별)
    * [18.1. 앞뒤 판별](README-ORIGIN.md#181-앞뒤-판별)
    * [18.2. 시야 판별](README-ORIGIN.md#182-시야-판별)
* [19. 조명 효과의 구현](README-ORIGIN.md#19-조명-효과의-구현)
* [20. 투영 벡터](README-ORIGIN2.md#20-투영-벡터)
* [21. 세 점의 결합](README-ORIGIN2.md#21-세-점의-결합)
* [22. 메시](README-ORIGIN2.md#22-메시)
* [23. 무게중심좌표](README-ORIGIN2.md#23-무게중심좌표)
    * [23.1. 무게중심좌표의 계산](README-ORIGIN2.md#231-무게중심좌표의-계산)
* [24. 텍스처 매핑](README-ORIGIN2.md#24-텍스처-매핑)
* [25. 3차원 공간의 설계](README-ORIGIN2.md#25-3차원-공간의-설계)
* [26. 3차원 공간의 트랜스폼](README-ORIGIN2.md#26-3차원-공간의-트랜스폼)
    * [26.1. 오일러 각](README-ORIGIN2.md#261오일러-각)
    * [26.2. 회전행렬의 유도](README-ORIGIN2.md#262-회전행렬의-유도)
    * [26.3. 3차원 모델링 행렬](README-ORIGIN2.md#263-3차원-모델링-행렬)
* [27. 카메라 공간](README-ORIGIN2.md#27-카메라-공간)
* [28. 오일러 각의 특징](README-ORIGIN2.md#28-오일러-각의-특징)
    * [28.1 짐벌락 현상](README-ORIGIN2.md#281-짐벌락-현상)
    * [28.2 회전 보간의 계산](README-ORIGIN2.md#282-회전-보간의-계산)
* [29. 벡터의 외적](README-ORIGIN2.md#29-벡터의-외적)
    * [29.1. 평행성 판별](README-ORIGIN2.md#291-평행성-판별)
    * [29.2. 법선 벡터](README-ORIGIN2.md#292-법선-벡터)
    * [29.3. 좌우 방향 판별](README-ORIGIN2.md#293-좌우-방향-판별)
* [30. 벡터로부터 회전행렬 생성](README-ORIGIN2.md#30-벡터로부터-회전행렬-생성)
* [31. 렌더링 계산량을 줄여주는 백페이스 컬링](README-ORIGIN2.md#31-렌더링-계산량을-줄여주는-백페이스-컬링)
* [32. 오일러 각의 문제를 해결하는 로드리게스 회전 공식](README-ORIGIN2.md#32-오일러-각의-문제를-해결하는-로드리게스-회전-공식)
* [33. 삼중곱](README-ORIGIN2.md#33-삼중곱)
    * [33.1. 스칼라 삼중곱](README-ORIGIN2.md#331-스칼라-삼중곱)
    * [33.2. 벡터 삼중곱](README-ORIGIN2.md#332-벡터-삼중곱)
* [34. 원근 투영 변환의 원리](README-ORIGIN2.md#34-원근-투영-변환의-원리)
* [35. 동차 좌표계](README-ORIGIN2.md#35-동차-좌표계)
* [36. 깊이 값](README-ORIGIN2.md#36-깊이-값)
* [37. 원근 보정 매핑](README-ORIGIN2.md#37-원근-보정-매핑)
* [38. 깊이 버퍼](README-ORIGIN2.md#38-깊이-버퍼)
* [39. 절두체 컬링](README-ORIGIN3.md#39-절두체-컬링)
    * [39.1. 평면의 방정식](README-ORIGIN3.md#391-평면의-방정식)
    * [39.2. 평면의 방정식의 정규화](README-ORIGIN3.md#392-평면의-방정식의-정규화)
    * [39.3. 평면의 방정식을 활용한 절두체 표현](README-ORIGIN3.md#393-평면의-방정식을-활용한-절두체-표현)
    * [39.4. 원근 투영 행렬로부터 평면의 방정식 만들기](README-ORIGIN3.md#394-원근-투영-행렬로부터-평면의-방정식-만들기)
* [40. 바운딩 볼륨](README-ORIGIN3.md#40-바운딩-볼륨)
    * [40.1. 구 바운딩 볼륨의 판정](README-ORIGIN3.md#401-구-바운딩-볼륨의-판정)
    * [40.2. aabb와의 판정](README-ORIGIN3.md#402-aabb와의-판정)
* [41. 삼각형 클리핑](README-ORIGIN3.md#41-삼각형-클리핑)
* [42. 복소수](README-ORIGIN3.md#42-복소수)
    * [42.1. 허수](README-ORIGIN3.md#421-허수)
    * [42.2. 복소수의 구조](README-ORIGIN3.md#422-복소수의-구조)
* [43. 복소평면](README-ORIGIN3.md#43-복소평면)
    * [43.1. 단위 복소수와의 곱](README-ORIGIN3.md#431-단위-복소수와의-곱)
    * [43.2. 켤레 복소수의 회전 변환](README-ORIGIN3.md#432-켤레-복소수의-회전-변환)
* [44. 복소수와 행렬의 관계](README-ORIGIN3.md#44-복소수와-행렬의-관계)
* [45. 자연지수함수](README-ORIGIN3.md#45-자연지수함수)
    * [45.1. 무리수 e](README-ORIGIN3.md#451-무리수-e)
    * [45.2. 자연지수함수](README-ORIGIN3.md#452-자연지수함수)
* [46. 미분](README-ORIGIN3.md#46-미분)
    * [46.1. 도함수](README-ORIGIN3.md#461-도함수)
    * [46.2. 자연지수함수의 도함수)](README-ORIGIN3.md#462-자연지수함수의-도함수)
    * [46.3. sin 함수와 cos 함수의 도함수)](README-ORIGIN3.md#463-sin-함수와-cos-함수의-도함수)
* [47. 급수](README-ORIGIN3.md#47-급수)
    * [47.1. 등비수열](README-ORIGIN3.md#471-등비수열)
    * [47.2. 급수](README-ORIGIN3.md#472-급수)
    * [47.3. 매클로린 급수](README-ORIGIN3.md#473-매클로린-급수)
* [48. 오일러 공식](README-ORIGIN3.md#48-오일러-공식)
* [49. 사원수 대수](README-ORIGIN3.md#49-사원수-대수)
    * [49.1. 사원수를 구성하는 세 허수](README-ORIGIN3.md#491-사원수를-구성하는-세-허수)
    * [49.2. 사원수의 구조](README-ORIGIN3.md#492-사원수의-구조)
    * [49.3. 사원수와 벡터](README-ORIGIN3.md#493-사원수와-벡터)
* [50. 사원수의 회전](#50-사원수의-회전)
    * [50.1. 사원수와 오일러 공식](#501-사원수와-오일러-공식)
    * [50.2. 회전 사원수를 이용한 3차원 공간에서의 회전](#502-회전-사원수를-이용한-3차원-공간에서의-회전)
* [51. 사원수의 변환](#51-사원수의-변환)
    * [51.1. 오일러 각에서 사원수로의 변환](#511-오일러-각에서-사원수로의-변환)
    * [51.2. 사원수에서 오일러 각으로의 변환](#512-사원수에서-오일러-각으로의-변환)
    * [51.3. 사원수에서 회전 변환행렬로의 변환](#513-사원수에서-회전-변환행렬로의-변환)
    * [51.4. 회전 변환행렬에서 사원수로의 변환](#514-회전-변환행렬에서-사원수로의-변환)
* [52. 사원수의 보간](#52-사원수의-보간)

# 50. 사원수의 회전
자연지수함수, $\sin$ 함수, $\cos$ 함수를 매클로린 급수로 전개했을 때 세 급수가 서로 통합되기 위해서는 크기가 1이고, 제곱한 수가 -1이 되는 특별한 수가 필요하다.     
복소수 체계에서 이 조건을 만족하는 특별한 수인 허수 $i$를 사용해 다음의 오일러 공식을 전개할 수 있다.

$$e^{i\theta} = \cos \theta + i \sin \theta = (\cos \theta, \sin \theta)$$

사원수에서도 허수 $i$와 동일하게 크기가 1이고 제곱한 값이 -1인 수가 있다면 오일러 공식을 만족한다.

# 50.1. 사원수와 오일러 공식
***크기가 1인 순허수 사원수도 크기가 1이고 제곱한 값이 -1이다***.     
크기가 1인 순허수 사원수를 $q_n$으로 지정하고 이를 직접 확인한다.       
먼저 순허수 사원수 $q_n$의 요소를 $(0, \vec{n})$으로 표시한다.      
$q_n$의 크기는 1이므로 다음의 식이 성립한다.

$$\sqrt{0 + |\vec{n}|^2} = 1$$

이로써 $\vec{n}$의 크기도 1이 됨을 알 수 있으며, 내적 $\vec{n} \cdot \vec{n}$의 값도 1이 된다.

$$|\vec{n}| = \vec{n} \cdot \vec{n} = 1$$

순허수 사원수 $q_n$의 제곱을 전개하면 다음과 같다.

$$q_n^2 = q_n \cdot q_n = (-\vec{n} \cdot \vec{n}, \vec{n} \times \vec{n})$$

그런데 $\vec{n} \cdot \vec{n}$은 1이고 ***평행한 벡터의 외적은 영벡터***가 되므로 위 식은 다음과 같이 간략하게 전개된다.

$$q_n \cdot q_n = (-1, \vec{0})$$

따라서 크기가 1인 순허수 사원수 $q_n$을 제곱한 결과는 $-1$이 됨을 확인할 수 있다.       
그렇다면 오일러 공식의 전개 과정에 허수 $i$대신 순허수 사원수의 벡터 $\vec{n}$을 사용할 수 있다.        
이렇게 하면 자연상수의 지수함수로 사원수의 회전을 표현하는 것이 가능하다.       
이를 수식으로 정리하면 단위 복소수와 형태가 유사해진다.

$$e^{\vec{n}\theta} = \cos \theta + \sin \theta \cdot \vec{n} = (\cos \theta, \sin \theta \cdot \vec{n})$$

$(\cos \theta, \sin \theta \cdot \vec{n})$ 형태의 사원수는 4차원 공간에서 회전축 $\vec{n}$을 중심으로 회전 변환하는 성질을 가지는데, 이를 ***회전 사원수(Rotation quaternion)*** 라고 한다.        
회전 사원수를 $q$, 벡터 $\vec{n}$의 요소를 $(a, b, c)$로 표기하고 이를 확인한다.        
여기서 벡터 $\vec{n}$은 크기가 1인 단위 벡터이므로 $a^2 + b^2 + c^2 = 1$의 조건에 의해 다음과 같이 전개되어 회전 사원수는 언제나 단위 사원수임을 확인할 수 있다.

$$q = \cos \theta + \sin \theta \cdot \vec{n} = \cos \theta + \sin \theta (ai + bj + ck)$$

$$|q| = \cos^2 \theta + \sin^2 \theta (a^2 + b^2 + c^2) = 1$$

회전 사원수의 켤레는 다음과 같이 표현한다.

$$q^* = (\cos \theta, -\sin \theta \cdot \vec{n})$$

이는 반대 방향의 회전을 의미한다.

$$q^* = (\cos(-\theta), \sin(-\theta) \cdot \vec{n})$$

반대 방향의 회전을 의미하는 회전 사원수의 켤레 사원수는 오일러의 공식으로도 확인할 수 있다.     
단위 사원수와 그 켤레를 곱한 값은 언제나 1이 나옴을 확인했는데, 이를 자연지수함수로 표현하면 다음과 같이 0의 지수로 나타낼 수 있다.

$$q \cdot q^* = 1 = e^0$$

오일러의 공식에 의해 회전 사원수에 대응하는 지수함수는 다음과 같다.

$$q = e^{\vec{n}\theta}$$

이를 회전 사원수 $q$에 치환한 식은 다음과 같이 전개된다.ㅣ

$$e^{\vec{n}\theta} \cdot q^* = e^0$$

이를 만족하는 $q^*$의 값은 $e^{-\vec{n}\theta}$이며 이는 같은 축 $\vec{n}$을 중심으로 반대 방향으로 $\theta$ 돌리는 회전을 의미한다.

$$\therefore q^* = e^{-\vec{n}\theta} = e^{\vec{n}(-\theta)}$$

# 50.2. 회전 사원수를 이용한 3차원 공간에서의 회전
회전 사원수 $q$를 사용해 임의의 회전축 $\vec{n}$에 대해 3차원 공간의 벡터 $\vec{v}$를 각 $\theta$만큼 회전시키는 방법을 확인해보자.

일반적으로 사용하는 ***3차원 공간의 벡터*** $\vec{v}$는 ***순허수 사원수에 대응되는 개념***이다.    
벡터 $\vec{v}$의 값을 $(x, y, z)$로 표시하고, 회전축 $\vec{n}$의 값을 $(a, b, c)$로 지정한다.       
회전축은 단위 벡터이기 때문에 $a^2 + b^2 + c^2 = 1$의 조건을 가진다.        
그리고 회전축 $\vec{n}$으로 각 $\theta$만큼 회전시키는 회전 사원수 $q$는 $(\cos \theta, \sin \theta \cdot \vec{n})$의 값을 가진다.

회전 사원수 $q$를 사용해 벡터를 회전시키는 방법은 회전 사원수를 벡터의 왼쪽에 배치하고 둘을 곱하는 것이다.          
이때 ***사원수의 곱셈은 교환법칙이 성립하지 않기 때문에 곱하는 순서에 항상 신경 써야 한다***.

회전 사원수와 순허수 사원수 벡터 $\vec{v}$의 곱셈은 다음과 같이 전개된다.

$$
\begin{matrix}
\vec{v^{'}} &=& q \cdot \vec{v} \\
&=& (\cos \theta, \sin \theta \cdot \vec{n}) \cdot (0, \vec{v}) \\
&=& (-\sin \theta (\vec{n} \cdot \vec{v}), \cos \theta \vec{v} + \sin \theta (\vec{n} \times \vec{v})) \\
\end{matrix}
$$

계산 결과를 살펴보면 ***회전 사원수와 벡터를 곱한 결과는 순허수 사원수가 아닌 네 요소를 모두 사용하는 일반 사원수가 나온다***.        
따라서 이 곱의 결과는 순허수 사원수와 1:1로 대응했던 3차원 공간의 규격에서 벗어나게 되므로 3차원 공간의 요소로 사용할 수 없게 된다.     
[그림 14-2](#그림-14-2-회전-사원수를-사용해-벡터를-회전시킨-결과)에 지금까지의 상황을 정리한다.

###### 그림 14-2 회전 사원수를 사용해 벡터를 회전시킨 결과
![회전 사원수를 사용해 벡터를 회전시킨 결과](/img/)

3차원 공간에서 벡터를 회전시키는 용도로 사원수를 사용하기 위해서는 ***사원수 곱의 결과가 항상 순허수 사원수가 되는 특별한 수식***을 발견해야 한다.        

회전 사원수의 벡터 $\vec{n}$은 회전축의 역할을 수행한다.        
이는 로드리게스 회전 공식에서 언급되는 축-각 회전에 대응하는 벡터다.     
3차원 공간에서 임의의 축 $\vec{n}$에 대한 회전을 표현하면 [그림 14-3](#그림-14-3-임의의-회전축-n에-대한-회전의-표현)과 같다.

###### 그림 14-3 임의의 회전축 n에 대한 회전의 표현
![임의의 회전축 n에 대한 회전의 표현](/img/)

회전시킬 벡터를 $\vec{v}$로 정하고 이를 회전축 $\vec{n}$에 평행한 성분과 수직인 성분으로 나눈다.            
회전축에 수평인 성분을 $\vec{v_\parallel}$, 수직인 성분을 $\vec{v_\perp}$으로 표시하면 다음 식이 성립된다.

$$\vec{v} = \vec{v_\parallel} + \vec{v_\perp}$$

[그림 14-4](#그림-14-4-회전시킬-벡터-v를-평행-성분과-수직-성분으로-분리한-결과)는 벡터 $\vec{v}$를 수직 성분과 수평 성분으로 분리해 나타낸 그림이다.        
이를 각 $\theta$만큼 회전 시킨 벡터를 $\vec{v^{'}}$로 가정한다.

###### 그림 14-4 회전시킬 벡터 v를 평행 성분과 수직 성분으로 분리한 결과
![회전시킬 벡터 v를 평행 성분과 수직 성분으로 분리한 결과](/img/)

이때 원하는 최종 회전의 벡터 $\vec{v^{'}}$는 [그림 14-5](#그림-14-5-3차원-공간에서의-회전의-구현)와 같이 회전축에 수직인 성분만 회전시킨 후, 수평 성분은 그대로 더하면 구할 수 있다.

###### 그림 14-5 3차원 공간에서의 회전의 구현
![3차원 공간에서의 회전의 구현](/img/)

따라서 3차원 공간에서의 회전은 다음과 같은 식이 될 것이다.

$$\vec{v^{'}} = \vec{v_\parallel} + q \cdot \vec{v_\perp}$$

***오일러 공식***을 활용해 위 수식을 간단하게 정리한다.       
이 식에서 회전 사원수 $q$를 자연지수함수로 바꿔 표현하면 다음과 같다.

$$\vec{v^{'}} = \vec{v_\parallel} + e^{\vec{n}\theta} \cdot \vec{v_\perp}$$

우변의 두 번째 항인 회전 사원수와 벡터와의 곱셈은 다음과 같이 간략하게 전개된다.

$$
\begin{matrix}
e^{\vec{n}\theta} \cdot \vec{v_\perp} &=& (-\sin \theta (\vec{n} \cdot \vec{v_\perp}), \cos \theta \vec{v_\perp} + \sin \theta (\vec{n} \times \vec{v_\perp})) \\
&=& (0, \cos \theta \vec{v_\perp} + \sin \theta (\vec{n} \times \vec{v_\perp})) \\
\end{matrix}
$$

회전축 $\vec{n}$와 이에 직교하는 벡터 $\vec{v_\perp}$의 내적은 항상 0이다.

이로써 회전축에 수직인 벡터와 회전 사원수의 곱으로 얻어지는 사원수는 항상 실수부 값이 0인 순허수 사원수가 되므로, 이의 결과는 언제나 3차원 공간의 벡터에 대응됨을 확인할 수 있다.

3차원 공간의 회전식을 간략하게 정리하도록 연산 순서를 바꾼다.       
연산 순서를 변경하면 ***외적의 성질***에 의해 $\sin$ ***함수의 부호가 반대로 바뀐다***.

$$\vec{v_\perp} \cdot e^{\vec{n} \theta} = (0, \cos \theta \vec{v_\perp} - \sin \theta (\vec{n} \times \vec{v_\perp}))$$

그러고 나서 회전 각에 $-\theta$를 대입하면, 이는 $\sin$ 함수에만 영향을 미치므로 다음과 같이 바뀐다.

$$
\begin{matrix}
\vec{v_\perp} \cdot e^{\vec{n}(-\theta)} &=& (0, \cos(-\theta) \vec{v_\perp} - \sin(-\theta)(\vec{n} \times \vec{v_\perp})) \\
&=& (0, \cos \theta \vec{v_\perp} + \sin \theta (\vec{n} \times \vec{v_\perp})) \\
\end{matrix}
$$

두 항의 순서를 바꿔 연산한 결과는 처음 식과 동일하므로 회전축과 직교하는 벡터에 대해서는 다음과 같은 식이 성립한다.

$$e^{\vec{n}\theta} \cdot \vec{v_\perp} = \vec{v_\perp} \cdot e^{\vec{n}(-\theta)}$$

수식에 등장하지 않지만 회전축에 평행한 벡터 $\vec{v_\parallel}$의 회전 사원수 곱이 가지는 성질을 살펴보자.      
평행인 두 벡터의 외적은 영벡터가 되므로 실수부가 남고 허수부가 단순화된다.

$$e^{\vec{n}\theta} \cdot \vec{v_\parallel} = (-\sin \theta (\vec{n} \cdot \vec{v_\parallel}), \cos \theta \vec{v_\parallel})$$

이때 사원수 곱에서 ***교환법칙의 성립을 방해하던 외적 부분***이 사라졌기 때문에, 평행인 벡터와의 곱은 다음과 같이 ***항상 교환법칙이 성립***한다.

$$e^{\vec{n}\theta} \cdot \vec{v_\parallel} = \vec{v_\parallel} \cdot e^{\vec{n}\theta}$$

식을 좀 더 단순화하기 위해, 회전 사원수를 둘로 쪼개서 나타낸다.     
각 $\theta$의 회전을 수행하는 회전 사원수는 이를 절반으로 나눈 각 $\frac{\theta}{2}$의 회전 사원수를 두 번 곱한 결과와 동일하다.

$$e^{\vec{n}\theta} = e^{\vec{n}(\frac{\theta}{2})} \cdot e^{\vec{n}(\frac{\theta}{2})}$$

회전 사원수와 그 켤레 사원수와의 곱은 아무런 변화 없는 $0^\circ$ 회전을 만들어내므로, 이들의 곱은 곱셈의 항등원 1에 대응된다.

$$1 = e^{0} = e^{\vec{n}(\frac{\theta}{2})} \cdot e^{\vec{n}(-\frac{\theta}{2})}$$

직교하는 벡터와 평행하는 벡터의 성질을 파악했다면, 이를 활용해 3차원 공간에서의 회전을 전개하면 다음과 같이 정리된다.

$$
\begin{matrix}
v' &=& \vec{v_\parallel} + e^{\vec{n}\theta} \cdot \vec{v_\perp} \\
&=& e^0 \cdot \vec{v_\parallel} + e^{\vec{n}\theta} \cdot \vec{v_\perp} \\
&=& e^{\vec{n}(\frac{\theta}{2})} \cdot e^{\vec{n}(-\frac{\theta}{2})} \cdot \vec{v_\parallel} + e^{\vec{n}(\frac{\theta}{2})} \cdot e^{\vec{n}(\frac{\theta}{2})} \cdot \vec{v_\perp} \\
&=& e^{\vec{n}(\frac{\theta}{2})} \cdot \vec{v_\parallel} \cdot e^{\vec{n}(-\frac{\theta}{2})} + e^{\vec{n}(\frac{\theta}{2})} \cdot \vec{v_\perp} \cdot e^{\vec{n}(-\frac{\theta}{2})} \\
&=& e^{\vec{n}(\frac{\theta}{2})} \cdot (\vec{v_\parallel} + \vec{v_\perp}) \cdot e^{\vec{n}(-\frac{\theta}{2})} \\
&=& e^{\vec{n}(\frac{\theta}{2})} \cdot \vec{v} \cdot e^{\vec{n}(-\frac{\theta}{2})} \\
\end{matrix}
$$

1. 평행한 벡터 $\vec{v_\parallel}$의 계수 1을 지수함수로 바꿔 표현한다.
2. 평행한 벡터의 계수는 두 개의 상반되는 회전의 곱으로 표현하고, 직교하는 벡터의 계수에 적용하는 회전은 절반 회전의 곱으로 표현한다.
3. 평행한 벡터와의 곱은 교환법칙이 성립하고, 직교하는 벡터와의 곱은 연산 순서를 바꿨을 때 각의 부호가 반대로 바뀐다.
4. 사원수는 덧셈의 분배법칙이 성립하므로 묶을 수 있다.
5. 평행한 벡터와 직교하는 벡터의 합은 원 벡터 $\vec{v}$가 된다.

간략해진 최종 식에서 자연지수함수를 다시 사원수의 형태로 바꾼다.        
각 $\theta$가 아닌 이의 절반값 $\frac{\theta}{2}$만큼 돌리는 회전 사원수를 $q$로 표현한다.      
반대 방향으로 돌리는 사원수는 켤레 사원수 $q^*$가 된다.

$$e^{\vec{n}(\frac{\theta}{2})} = q$$

3차원 공간의 회전을 보장하는 사원수의 회전식은 [식 14-1](#식-14-1)과 같이 최종 정리된다.

###### 식 14-1

$$
\begin{matrix}
v' &=& e^{\vec{n}(\frac{\theta}{2})} \cdot \vec{v} \cdot e^{\vec{n}(-\frac{\theta}{2})} \\
&=& q \cdot v \cdot q^* \\
\end{matrix}
$$

회전 사원수에 사용한 각은 $\frac{\theta}{2}$이므로 여기에 사용한 사원수 $q$의 값은 다음과 같다.

$$q = (\cos \frac{\theta}{2}, \sin \frac{\theta}{2}\vec{n})$$

3차원 공간의 회전을 보장하는 사원수의 회전식이 [식 14-1](#식-14-1)로 깔끔하게 정리된다.     
절반의 각만 회전시키는 단위 사원수를 임의의 벡터와 곱했을 때 그 결과는 항상 실수부가 0인 순허수 사원수가 나오는지 확인해보자.       
회전 사원수 $q$의 실수부와 허수부를 각각 $w$와 $\vec{r}$로 표시해 식을 간단하게 전개한다.

$$q = (\cos \frac{\theta}{2}, \sin \frac{\theta}{2}\vec{n}) = (w, \vec{r})$$

[식 14-1](#식-14-1)을 내적과 외적의 형태로 바꾸면 다음과 같이 전개된다.

$$
\begin{matrix}
v' &=& q \cdot v \cdot q* \\
&=& (w, \vec{r}) \cdot (0, \vec{v}) \cdot (w, -\vec{r}) \\
&=& (-(\vec{r} \cdot \vec{v}), w\vec{v} + \vec{r} \times \vec{v}) \cdot (w, -\vec{r}) \\
&=& (-(\vec{r} \cdot \vec{v})w - (w\vec{v} + \vec{r} \times \vec{v}) \cdot (-\vec{r}), -(\vec{r} \cdot \vec{v}) \cdot -\vec{r} + w(w\vec{v} + \vec{r} \times \vec{v}) + (w\vec{v} + \vec{r} \times \vec{v}) \times -\vec{r}) \\
\end{matrix}
$$

이 결과 중에서 실수부와 허수부를 다음과 같이 각각 따로 전개한다.        
우선 첫 항인 실수부를 전개하면 다음과 같다.

$$
\begin{matrix}
-(\vec{r} \cdot \vec{v})w - (w\vec{v} + \vec{r} \times \vec{v}) \cdot (-\vec{r}) &=& -(\vec{r} \cdot \vec{v})w + w(\vec{v} \cdot \vec{r}) + (\vec{r} \times \vec{v}) \cdot \vec{r} \\
&=& -(\vec{r} \cdot \vec{v})w + w(\vec{v} \cdot \vec{r}) \\
&=& -(\vec{r} \cdot \vec{v})w + (\vec{r} \cdot \vec{v})w \\
&=& 0
\end{matrix}
$$

1. $(\vec{r} \times \vec{v}) \cdot \vec{r}$ 항의 결과는 외적으로 직교하는 벡터를 생성한 후에 이를 내적하므로 언제나 0이 나온다.
2. 내적은 교환법칙이 성립하므로 스칼라와 벡터의 순서를 동일하게 맞춰준다.

[식 14-1](#식-14-1)을 내적과 외적으로 전개했을 때 실수부 값은 언제나 0이 나온다.        
이는 [그림 14-6](#그림-14-6-실수부가-0인-3차원-공간에서의-회전을-보장하는-사원수의-곱셈-공식)과 같이 절반의 각과 그 켤레를 사용해 회전시킨 결과는 항상 3차원 공간의 벡터에 대응된다고 할 수 있다.

###### 그림 14-6 실수부가 0인 3차원 공간에서의 회전을 보장하는 사원수의 곱셈 공식
![실수부가 0인 3차원 공간에서의 회전을 보장하는 사원수의 곱셈 공식](/img/)

허수부의 결과는 어떻게 정리되는지 확인해보자.       
허수부는 사원수를 사용해 회전된 벡터 $\vec{v'}$가 나온다.       
허수부의 수식을 전개하면 다음과 같다.

$$
\begin{matrix}
\vec{v'} &=& -(\vec{r} \cdot \vec{v}) \cdot -\vec{r} + w(w\vec{v} + \vec{r} \times \vec{v}) + (w\vec{v} + \vec{r} \times \vec{v}) \times -\vec{r} \\
&=& (\vec{r} \cdot \vec{v}) \cdot \vec{r} + w^2\vec{v} + w(\vec{r} \times \vec{v}) - w(\vec{v} \times \vec{r}) - (\vec{r} \times \vec{v}) \times \vec{r} \\
&=& (\vec{r} \cdot \vec{v}) \cdot \vec{r} + w^2\vec{v} + 2w(\vec{r} \times \vec{v}) - (\vec{r} \times \vec{v}) \times \vec{r} \\
&=& (\vec{r} \cdot \vec{v}) \cdot \vec{r} + (1 - \vec{r} \cdot \vec{r}) \cdot \vec{v} + 2w(\vec{r} \times \vec{v}) - (\vec{r} \times \vec{v}) - (\vec{r} \times \vec{v}) \times \vec{r} \\
&=& \vec{v} + (\vec{r} \cdot \vec{v}) \cdot \vec{r} - (\vec{r} \cdot \vec{r}) \cdot \vec{v} + 2w(\vec{r} \times \vec{v}) - (\vec{r} \times \vec{v}) \times \vec{r} \\
&=& \vec{v} + \vec{r} \times (\vec{r} \times \vec{v}) + 2w(\vec{r} \times \vec{v}) - (\vec{r} \times \vec{v}) \times \vec{r} \\
&=& \vec{v} + 2w(\vec{r} \times \vec{v}) + 2(\vec{r} \times (\vec{r} \times \vec{v})) \\
\end{matrix}
$$

1. 외적은 순서를 바꾸면 반대 부호가 나오므로 $w(\vec{r} \times \vec{v}) - w(\vec{v} \times \vec{r})$는 $2w(\vec{r} \times \vec{v})$가 된다.
2. 회전 사원수는 단위 사원수이므로 $w^2 + |\vec{r}|^2 = 1$이 성립하는데, 이를 내적으로 바꾸면 $w^2 = 1 - \vec{r} \cdot \vec{r}$이 성립한다.
3. 벡터 삼중곱 공식을 사용해 $(\vec{r} \cdot \vec{v}) \cdot \vec{r} - (\vec{r} \cdot \vec{r}) \cdot \vec{v}$를 벡터 삼중곱 $\vec{r} \times (\vec{r} \times \vec{v})$로 치환한다.
4. 마지막 항에 위치한 외적식의 순서를 뒤집어 벡터 삼중곱으로 변환한 외적식과 함께 묶는다.

최종 값 $\vec{v} + 2w(\vec{r} \times \vec{v}) + 2(\vec{r} \times (\vec{r} \times \vec{v}))$에서 $2(\vec{r} \times \vec{v})$를 벡터 $\vec{t}$로 치환하면 위 식은 [식 14-2](#식-14-2)와 같이 단순하게 정리된다.

###### 식 14-2

$$\vec{v'} = \vec{v} + w\vec{t} + \vec{r} \times \vec{t}$$

이로써 사원수를 사용해 3차원 공간의 벡터 $\vec{v}$를 임의의 회전축 $\vec{n}$을 중심으로 각 $\theta$만큼 회전시키는 최종 수식이 완성된다.

[식 14-2](#식-14-2)를 $\frac{\theta}{2}$가 아닌 각 $\theta$를 중심으로 전개하면 [식 9-2](#식-9-2)의 로드리게스 회전 공식이 유도된다.

$$
\begin{matrix}
\vec{v'} &=& \vec{v} + 2w(\vec{r} \times \vec{v}) + 2(\vec{r} \times (\vec{r} \times \vec{v})) \\
&=& \vec{v} + 2 \cos \frac{\theta}{2}(\sin\frac{\theta}{2}\vec{n}\times \vec{v}) + 2(\sin\frac{\theta}{2}\vec{n} \times (\sin \frac{\theta}{2} \vec{n} \times \vec{v})) \\
&=& \vec{v} + 2 \cos \frac{\theta}{2}\sin\frac{\theta}{2}(\vec{n} \times \vec{v}) + 2\sin^2 \frac{\theta}{2}(\vec{n} \times (\vec{n} \times \vec{v})) \\
&=& \vec{v} + \sin(\frac{\theta}{2} + \frac{\theta}{2})(\vec{n} \times \vec{v}) + (1 - \cos(\frac{\theta}{2} + \frac{\theta}{2})) (\vec{n} \times (\vec{n} \times \vec{v})) \\
&=& \vec{v} + \sin \theta(\vec{n} \times \vec{v}) + (1 - \cos \theta)((\vec{n} \cdot \vec{v})\vec{n} - (\vec{n} \cdot \vec{n})\vec{v}) \\
&=& \vec{v} - (1 - \cos \theta)(\vec{n} \cdot \vec{n})\vec{v} + \sin \theta(\vec{n} \times \vec{v}) + (1 - \cos \theta)(\vec{n} \cdot \vec{v})\vec{n} \\
&=& \cos \theta \vec{v} + (1 - \cos \theta)(\vec{n} \cdot \vec{v})\vec{n} + \sin \theta(\vec{n} \times \vec{v}) \\
\end{matrix}
$$

1. [식 14-2](#식-14-2)를 삼각함수와 회전축으로 바꿔 표현한다.
2. 각 요소에 사용한 모든 삼각함수 값을 계수로 빼서 정리한다.
3. 삼각함수의 배각 공식 $\sin 2\theta = 2\sin\theta \cos \theta$와 $\cos 2 \theta = 1- 2\sin^2\theta$를 사용해 $\frac{\theta}{2}$의 삼각함수를 $\theta$의 삼각함수로 변경한다.
4. 벡터 삼중곱을 내적으로 구성된 수식으로 변경한다.

이로써 회전 사원수의 벡터부에서 설정한 벡터 $\vec{n}$은 축-각 회전에서 회전축의 기능을 수행한다는 사실을 확인할 수 있다.        
그리고 각 $\theta$를 기준으로 전개했을 때보다 각 $\frac{\theta}{2}$를 기준으로 전개했을 때 식이 더 간편해진다는 것을 알 수 있다.

같은 회전축에 두 개의 다른 각을 연속해서 회전시키는 경우를 알아보자.        
첫 번째 각의 크기를 $2\alpha$, 두 번째 각의 크기를 $2\beta$로 지정하고 회전할 벡터를 $\vec{v}$, 첫 번째 회전을 적용한 벡터를 $\vec{v'}$, 두 번째 회전을 적용한 벡터를 $\vec{v''}$로 표기하면 두 회전 변환을 적용한 식은 다음과 같다.

$$\vec{v'} = q_\alpha \cdot \vec{v} \cdot q^*_\alpha$$

$$\vec{v''} = q_\beta \cdot \vec{v'} \cdot q^*_\beta$$

벡터 $\vec{v'}$를 $q_\alpha \cdot \vec{v} \cdot q^*_\alpha$로 치환하면 $\vec{v''}$를 계산하는 식은 다음과 같이 전개된다.

$$
\begin{matrix}
\vec{v''} &=& q_\beta \cdot (q_\alpha \cdot \vec{v} \cdot q_\alpha^*) \cdot q_\beta^* \\
&=& (q_\beta \cdot q_\alpha) \cdot \vec{v} \cdot (q_\alpha^* \cdot q_\beta^*) \\
&=& (q_\beta \cdot q_\alpha) \cdot \vec{v} \cdot (q_\beta \cdot q_\alpha)^* \\
&=& q_{(\alpha + \beta)} \cdot \vec{v} \cdot q^*_{(\alpha + \beta)} \\
\end{matrix}
$$

1. 사원수의 곱셈은 결합법칙을 만족하므로 벡터를 가운데 두고 양 옆으로 묶을 수 있다.
2. 켤레 사원수로 묶으면 두 사원수의 순서는 뒤집힌다.
3. 두 회전 사원수의 곱은 두 각을 더한 회전 사원수와 동일하다.

이로써 ***3차원 공간의 회전을 위해 절반의 각과 켤레 사원수를 사용하더라도 서로 다른 두 회전 사원수의 곱은 두 각을 합한 회전 사원수와 형태가 동일하다***는 점을 확인할 수 있다.        

# 51. 사원수의 변환
사원수를 활용해 3차원 벡터를 회전시키는 기능을 구현할 수 있지만, 사원수를 구성하는 요소 값은 직관적이지 않아 실제로 사용하는 회전을 설계할 때 어려움이 따른다.

3차원 공간에서 물체의 회전을 설정할 때에는 오일러 각 방식이 사원수보다 직관적이고 편리하기 때문에, 오일러 각의 값을 사원수로 변환해주는 기능을 만들면 게임 제작에 유용하게 사용할 수 있다.

# 51.1. 오일러 각에서 사원수로의 변환
***오일러 각의 각 회전은*** $x, y, z$ ***기저 축이 회전축의 역할을 수행***한다.     
3차원 공간에서 $x$축을 중심으로 각 $\theta$만큼 회전시키는 데 사용하는 회전 사원수 $q$는 다음과 같다.

$$q = (\cos \frac{\theta}{2}, \sin \frac{\theta}{2} \cdot \vec{x}) = \cos \frac{\theta}{2} + \sin \frac{\theta}{2} i$$

따라서 오일러 각을 구성하는 롤, 피치, 요 회전에 대응하는 각 사원수 $q_{roll}, q_{pitch}, q_{yaw}$는 각각 다음과 같이 표기된다.

$$q_{roll} = \cos \frac{\theta_{roll}}{2} + \sin \frac{\theta_{roll}}{2}k$$

$$q_{pitch} = \cos \frac{\theta_{pitch}}{2} + \sin \frac{\theta_{pitch}}{2}i$$

$$q_{yaw} = \cos \frac{\theta_{yaw}}{2} + \sin \frac{\theta_{yaw}}{2}j$$

오일러 각의 회전 순서를 롤, 피치, 요 순으로 적용하고, 이에 대응하는 사원수를 동일한 순서에 맞춰서 곱하면 오일러 각에 대응하는 사원수가 만들어진다.        
이를 계산하면 [식 14-3](#식-14-3)과 같다.

###### 식 14-3

$$q_{yaw} \cdot q_{pitch} \cdot q_{roll} = \cos \frac{\theta_{roll}}{2} \cos \frac{\theta_{pitch}}{2} \cos \frac{\theta_{yaw}}{2} + \sin \frac{\theta_{roll}}{2} \sin \frac{\theta_{pitch}}{2} \sin \frac{\theta_{yaw}}{2} + \\
(\cos \frac{\theta_{roll}}{2} \sin \frac{\theta_{pitch}}{2} \cos \frac{\theta_{yaw}}{2} + \sin \frac{\theta_{roll}}{2} \cos \frac{\theta_{pitch}}{2} \sin \frac{\theta_{yaw}}{2})i + \\
(\cos \frac{\theta_{roll}}{2} \cos \frac{\theta_{pitch}}{2} \sin \frac{\theta_{yaw}}{2} - \sin \frac{\theta_{roll}}{2} \sin \frac{\theta_{pitch}}{2} \cos \frac{\theta_{yaw}}{2})j + \\
(\sin \frac{\theta_{roll}}{2} \cos \frac{\theta_{pitch}}{2} \cos \frac{\theta_{yaw}}{2} - \cos \frac{\theta_{roll}}{2} \sin \frac{\theta_{pitch}}{2} \sin \frac{\theta_{yaw}}{2})k$$

# 51.2. 사원수에서 오일러 각으로의 변환
거꾸로 사원수로부터 오일러 각의 값을 변환하는 방법에 대해 알아보자.     
[식 14-3](#식-14-3)에서 실수부를 $w$, 각 허수부 값을 $x, y, z$로 치환한 후 $2(wz + xy)$를 계산한 결과를 살펴본다.       
요, 롤 피치의 절반각을 $y, r, p$로 표기하고, 이들의 $\sin$ 값을 $sy, sr, sp$로 지정하고 $\cos$ 값을 $cr, cp, cy$로 지정해 식을 전개하면 다음과 같다.

$$
\begin{matrix}
w &=& cr \cdot cp \cdot cy + sr \cdot sp \cdot sy \\
z &=& sr \cdot cp \cdot cy - cr \cdot sp \cdot sy \\
wz &=& cy^2 \cdot cr \cdot cp^2 \cdot sr - cy \cdot ct^2 \cdot cp \cdot sy \cdot sp + cy \cdot cp \cdot sy \cdot sr^2 \cdot sp - cr \cdot sy^2 \cdot sr \cdot sp^2 \\
x &=& sy \cdot sr \cdot cp + sp \cdot cy \cdot cr \\
y &=& sy \cdot cp \cdot cr - sp \cdot sr \cdot cy \\
xy &=& cr \cdot cp^2 \cdot sy^2 \cdot sr - cy \cdot cp \cdot sy \cdot sr^2 \cdot sp + cy \cdot cr^2 \cdot cp \cdot sy \cdot sp - cy^2 \cdot cr \cdot sr \cdot sp^2 \\
\end{matrix}
$$

사원수로부터 오일러 각을 구하려면 사원수를 잘 조합해 단일 각에 대한 삼각함수가 나오도록 식을 설정해야 한다.     
롤 회전에 대한 삼각함수를 만들어주는 $wz + xy$의 값을 계산한다.

$$
\begin{matrix}
wz + xy &=& cr \cdot cp^2 \cdot sr - (cy \cdot cp \cdot sy \cdot sp) + cy \cdot cp \cdot sy \cdot sp - (cr \cdot sr \cdot sp^2) \\
&=& cr \cdot sr(cp^2 - sp^2) \\
&=& \frac{\sin(2r)}{2} \cdot \cos (2p) \\
\end{matrix}
$$

삼각함수의 배각 공식을 사용해 두 배의 각으로 변환한다.

$2(wz + xy)$의 값은 $\sin\theta_{roll} \cdot \cos \theta_{pitch}$가 된다.       
같은 방식으로 $1 - 2(z^2 + x^2)$를 계산하면 $\cos \theta_{roll} \cdot \cos \theta_{pitch}$가 된다.      
그렇다면 $\sin\theta_{roll} \cdot \cos\theta_{pitch}$ 값을 $\cos\theta_{roll} \cdot \cos \theta_{pitch}$로 나누면 다음과 같이 롤 회전의 $\tan$ 값이 나온다.

$$\frac{\sin\theta_{roll} \cdot \cos\theta_{pitch}}{\cos\theta_{roll} \cdot \cos\theta_{pitch}} = \tan\theta_{roll} = \frac{2(wz + xy)}{(1 - 2(z^2 + x^2))}$$

이제 롤 회전의 값은 $\arctan$ 함수를 사용해 구할 수 있다.

$$\theta_{roll} = atan2(2(wz + xy), 1 - 2(z^2 + x^2))$$

피치 회전에 대한 삼각함수를 만들어주는 $wx - yz$ 값은 다음과 같이 전개된다.

$$
\begin{matrix}
wx - yz &=& \sin\frac{\theta_{pitch}}{2} \cdot \cos\frac{\theta_{pitch}}{2} \\
&=& \frac{1}{2}\sin\theta_{pitch} \\
\end{matrix}
$$

$\sin$ 함수의 배각 공식을 사용해 간략화 한다.

따라서 피치 회전각은 $\arcsin$ 함수를 사용해 구할 수 있다.

$$\theta_{pitch} = asin(2(wx - yz))$$

이때 주의할 점은 $\arcsin$ 함수의 정의역은 $|-1, 1|$ 범위로 제한되어 있으므로 $wx - yz$ 값이 $|-0.5, 0.5|$ 범위를 벗어나지 않는지 확인하고 벗어나는 경우에는 범위 내 가장 가까운 값으로 설정해야 한다.

요 회전은 롤 회전과 유사한 방식으로 요 회전의 $\tan$ 함수 값을 구한 후 $\arctan$ 함수를 사용한다.

$$\theta_{yaw} = atan2(2(wy + xz), 1 - 2(x^2 + y^2))$$

# 51.3. 사원수에서 회전 변환행렬로의 변환
사원수에서 회전 변환행렬로 변환하는 식을 계산해보자.        
***회전 변환행렬은 로컬 축으로 구성***되어 있기 때문에 사원수를 사용해 회전된 세 로컬 축의 값을 구하면 쉽게 해결할 수 있다.       
[식 14-2](#식-14-2)를 활용해 사원수로 로컬축을 회전한 결과를 계산한다.

사원수를 구성하는 네 요소를 $x, y, z, w$라고 할 때 $\vec{r}$의 값은 $(x, y, z)$이 되고 여기에 회전시킬 벡터 값을 $\vec{v}$에 대입하면 외적 식으로 회전된 벡터 값을 계산할 수 있다.      
먼저 회전할 벡터는 $x$축 기저벡터 $(1, 0, 0)$이다.      
이를 계산한 결과는 사원수에 의해 회전된 $x$ 로컬 축을 의미한다.

$$
\begin{matrix}
x_{local} &=& (1, 0, 0) + w(0, 2z, -2y) + (x, y, z) \times (0, 2z, -2y) \\
&=& (1, 2zw, -2yw) + (-2y^2 - 2z^2, 2xy, 2xz) \\
&=& (1 - 2(y^2 + z^2), 2(xy + zw), 2(xz - yw)) \\
\end{matrix}
$$

마찬가지로 동일한 사원수에 벡터 $(0, 1, 0), (0, 0, 1)$을 곱하면 각각 다음 식이 나온다.

$$y_{local} = (2(xy - zw), 1 - 2(x^2 + z^2), 2(yz + xw))$$

$$z_{local} = (2(xz + yw), 2(yz - xw), 1 - 2(x^2 + y^2))$$

모든 로컬 축을 구했다면, 이들을 꽂아 넣으면 회전 변환행렬을 만들 수 있다.

###### 식 14-4

$$
\begin{bmatrix}
1-2(y^2 + z^2) & 2(xy - zw) & 2(xz + yw) \\
2(xy + zw) & 1-2(x^2 + z^2) & 2(yz - xw) \\
2(xz - yw) & 2(yz + xw) & 1-2(x^2 + y^2) \\
\end{bmatrix}
$$

# 51.4. 회전 변환행렬에서 사원수로의 변환
회전 변환행렬에서 사원수를 구하는 방법을 알아보자.      
[식 14-4](#식-14-4)를 통해 사원수에서 회전행렬을 구하는 식을 확인했다.      
행렬의 요소를 조합해서 사원수를 구성하는 $x, y, z, w$ 값을 개별로 구하는 방법을 찾아야 한다.        
이는 정방행렬의 모든 대각 성분의 합을 더하는 것에서 실마리를 찾을 수 있다.      
***정방행렬의 대각 성분을 모두 더한 값***을 ***트레이스(Trace)*** 라고 하는데, [그림 14-7](#그림-14-7-정방행렬에서의-트레이스의-표현)과 같이 행렬의 성분과 연산을 표현한다.

###### 그림 14-7 정방행렬에서의 트레이스의 표현
![정방행렬에서의 트레이스의 표현](/img/)

[식 14-4](#식-14-4)의 회전 변환행렬에서 대각행렬 값을 모두 더한 트레이스 $t$는 다음과 같이 계산된다.

$$
\begin{matrix}
t &=& 1 - 2(y^2 + z^2) + 1-2(x^2 + z^2) + 1-2(x^2 + y^2) \\
&=& 3-4(x^2 + y^2 + z^2) \\
\end{matrix}
$$

여기에 1을 더하면 제곱근을 씌울 수 있는 형태가 나오는데 크기가 1인 회전 사원수의 성질에 의해 $x^2 + y^2 + z^2$의 값은 $1 - w^2$이 되므로 트레이스 값은 $4w^2$가 된다.

$$t + 1 = 4 - 4(x^2 + y^2 + z^2) = 4w^2$$

여기에 제곱근을 씌운 값에서 양수 값을 $r$로 지정하면 $r$과 트레이스 $t$의 관계는 다음과 같다.

$$r = 2w = \sqrt{t + 1}$$

사원수의 $w$값은 다음과 같이 구할 수 있다.

$$w = \frac{1}{2}r$$

여기서 구한 $w$ 값을 이용해 나머지 값 $x, y, z$를 구한다.       
회전 변환행렬을 살펴보면 대각 방향으로 대칭된 행렬의 요소를 서로 빼면 두 사원수 요소의 곱으로 정리된다.     
예를 들어 두 번째 열 벡터의 세 번째 요소에서 세 번째 열벡터의 두 번째 요소를 빼면 다음 식이 만들어진다.

$$2yz + 2xw - 2yz + 2xw = 4xw$$

이 식을 그림으로 나타내보면 [그림 14-8]과 같다.     
[그림 14-7](#그림-14-7-정방행렬에서의-트레이스의-표현)과 색상이 다른 부분은 빼는 요소를 의미한다.

###### 그림 14-8 xw값을 구하기 위한 행렬의 성분
![xw값을 구하기 위한 행렬의 성분](/img/)

비슷한 방법으로 세 번째 열벡터의 첫 번째 요소에서 첫 번째 열벡터의 세 번째 요소를 빼면 $yw$를 구할 수 있다.

$$2xz + 2yw - 2xz + 2yw = 4yw$$

마지막으로 첫 번째 열벡터의 두 번째 요소에서 두 번째 열벡터의 첫 번째 요소를 빼면 $zw$값이 얻어진다.

$$2xy + 2zw - 2xy + 2zw = 4zw$$

[그림 14-9](#그림-14-9-yw-zw-값을-구하기-위한-행렬의-성분)의 (a)에 $yw$를 구하는 식에 사용하는 행렬의 요소를, (b)에는 $zw$를 구하는 식에 사용되는 행렬의 요소를 정리한다.

###### 그림 14-9 yw, zw 값을 구하기 위한 행렬의 성분
![yw, zw 값으 구하기 위한 행렬의 성분](/img/)

이 방식으로 사원수를 구할 때는 예외 사항이 있다.      
트레이스 값이 -1보다 작거나 같으면 제곱근을 구하는 값이 0보다 작거나 같아져 $w$를 구하는 데 필요한 $r$의 해가 존재하지 않는다.      
예를 들어 $y$축으로 180도 회전하는 행렬은 $x$ 기저와 $z$ 기저를 반대 방향으로 돌리므로 다음과 같이 구성된다.

$$
\begin{bmatrix}
-1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & -1 \\
\end{bmatrix}
$$

이 행렬을 사용하는 경우 트레이스 값은 -1이 되고 $w$값은 0이 된다.     
0의 역수는 존재하지 않기 때문에 나머지 값들을 구할 수 없게 된다.        
이러한 경우, $w$가 아닌 다른 요소부터 계산한 후에 이로부터 다른 성분을 구하도록 계산 방법을 우회해야 한다.      
주어진 회전 변환행렬에서 첫 번째 대각 성분과 두 번째와 세 번째 대각 성분을 빼면 다음과 같다.

$$1 - 2y^2 - 2z^2 - 1 + 2x^2 + 2z^2 - 1 + 2x^2 + 2y^2 = -1 + 4x^2$$

그렇다면 이를 사용해 $x$값을 구할 수 있다.      
이 수식을 그림으로 표현하면 [그림 14-10](#그림-14-10-예외-상황에서-x값을-구하기-위한-대각-성분)과 같다.

###### 그림 14-10 예외 상황에서 x값을 구하기 위한 대각 성분
![예외 상황에서 x값을 구하기 위한 대각 성분](/img/)

$y$값은 두 번째 대각 성분에 첫 번째와 세 번째를 빼서 얻을 수 있으며 $z$값은 세 번째 대각 성분에 첫 번째와 두 번째를 빼서 얻을 수 있다.      
$y, z$값을 구하는 식을 만들기 위한 행렬의 요소를 순서대로 정리하면 [그림 14-11](#그림-14-11-y-z값을-구하기-위한-대각-성분)과 같다.

###### 그림 14-11 y, z값을 구하기 위한 대각 성분
![y, z값을 구하기 위한 대각 성분](/img/)

예외 상황을 감안해 회전 변환행렬로부터 사원수를 구하는 알고리즘이 1985년에 ***켄 슈메이크(Ken Shoemake)*** 에 의해 고안됐다.       
먼저 회전 변환행렬의 트레이스 값을 구하고 그 값이 충분히 큰지를 파악한다.       
***이론적으로 트레이스 값이 -1보다 크면*** $w$ ***값 계산이 가능하지만, -1에 가까워질수록 오차가 발생***하므로 ***트레이스 값이 0보다 큰 경우에만 트레이스 값을 토대로 사원수의 모든 요소를 구하는 로직을 적용***한다.     
***나머지 트레이스 값이 0보다 작거나 같은 경우에는 예외 상황으로 간주해 다른 값부터 구하는 것이 이 알고리즘의 핵심***이다.        
$w$를 제외하고 $x, y, z$ 중에서 가장 큰 요소를 파악한다.        
각 대각행렬의 요소 값을 비교하면 확인할 수 있다.        
예를 들어 대각행렬의 첫 번째 대각 요소와 두 번째 대각 요소의 크기를 비교했을 때 두 번째 요소 값이 크다면 $y$의 크기는 $x$보다 크다는 의미다.

$$1 - 2(y^2 + z^2) < 1 - 2(x^2 + z^2)$$

$$-y^2 < -x^2$$

이 과정을 한 번 더 거치면 $x, y, z$에서 가장 큰 요소를 찾을 수 있다.        
이렇게 파악된 가장 큰 요소의 값을 먼저 구한다.      
참고로 제곱근으로 해를 구할 때는 항상 양수를 사용한다.      
이와 같은 방법으로 가장 큰 수를 구했다면 나머지 두 요소는 $xy, yz, xz$ 값으로부터 얻을 수 있는데 이들을 구하기 위한 행렬의 요소를 [그림 14-12](#그림-14-12-순서대로-xy-yz-xz-값을-구하기-위한-행렬의-성분)에 (a), (b), (c) 순서대로 정리한다.

###### 그림 14-12 순서대로 xy, yz, xz 값을 구하기 위한 행렬의 성분
![순서대로 xy, yz, xz 값을 구하기 위한 행렬의 성분](/img/)

$x, y, z$를 모두 구했다면 마지막 $w$값은 [그림 14-8](#그림-14-8-xw값을-구하기-위한-행렬의-성분)과 [그림 14-9](#그림-14-9-yw-zw-값을-구하기-위한-행렬의-성분)에서 구한 $xw, yw, zw$의 값으로부터 구한다.     

# 52. 사원수의 보간
***사원수는 로드리게스 회전과 동일한 축-각 방식을 사용해 3차원 공간의 회전을 표현***한다.     
사원수를 사용하는 경우의 장점을 열거해보면 다음과 같다.     

- ***오일러 각과 쉽게 변환이 가능***하며 ***회전행렬 제작이 용이***하다.
- ***임의의 축에 대한 회전 표현이 가능***하기 때문에 ***짐벌락 현상을 방지***할 수 있다.
- ***임의의 축에 대한 회전 보간 값***을 구할 수 있다.
- ***4개의 숫자로 회전을 표현***하기 때문에 저장 공간을 효율적으로 쓸 수 있다.

또한 사원수는 행렬과 상호 변환이 가능하다.      
다른 회전 방식과 비교한 사원수의 장단점은 [표 14-3](#식-14-3)과 같다.

###### 표 14-3 3차원 회전 표현의 장단점 비교

||오일러 각|행렬|사원수|
|---|---|---|---|
|저장공간|가장 작다. 저장 공간의 수는 3|크다. 저장 공간의 수는 9|작다. 저장 공간의 수는 4|
|짐벌락 현상|발생|발생하지 않음|발생하지 않음|
|회전 보간|한 기저 축에 대해서만 가능|불가능|임의의 축에 가능|
|직관성|직관적이다.|직관적이지 않다.|직관적이지 않다.|

다른 회전 방식에 비해 ***사원수가 가지는 장점***은 ***회전 보간이 가능***하다는 것이다.     
사원수를 4차원 공간의 벡터로 생각하고, 두 사원수가 만들어내는 4차원 공간에서의 평면을 상상해보자.   
해당 평면에서 주어진 비율 $t$에 대응하는 사원수는 두 사원수의 위치를 선형 보간한 지점이 된다.       
두 사원수가 만든 평면에서 $\frac{1}{3}$만큼 보간된 사원수를 구하는 방법은 [그림 14-13](#그림-14-13-시작점-q_1에서-끝점-q_2까지-13-만큼-선형-보간된-사원수의-위치)과 같이 계산할 수 있다.

###### 그림 14-13 시작점 q_1에서 끝점 q_2까지 1/3 만큼 선형 보간된 사원수의 위치
![시작점 q_1에서 끝점 q_2까지 1/3 만큼 선형 보간된 사원수의 위치](/img/)

주어진 비율 $t$에 대응하는 중간 사원수를 구하는 식은 다음과 같다.

$$q(t) = (1 - t) \cdot q_1 + t \cdot q_2$$

하지만 선형 보간으로 얻어지는 사원수는 크기가 1인 단위 사원수가 아니기 때문에 해당 사원수를 회전에 사용하려면 정규화 과정을 거쳐야 한다.

$$q' = \frac{q(t)}{|q(t)|}$$

***선형 보간법은 빠르고 간편***하게 사용할 수 있지만, ***원의 궤적을 따라 발생하는 회전을 정확히 반영하지는 못한다***.      
좀 더 높은 수준의 결과물을 위해 회전의 움직임을 따르는 중간 사원수를 구하려면 두 사원수가 이루는 각을 $\theta$로 지정하고 주어진 비율 $t$를 사용해 두 각을 각각 $t\theta$와 $(1 - t)\theta$로 나눠야 한다.      
이해를 돕기 위해 비율값 $t$로 $\frac{1}{3}$이 주어졌다면 구하려는 최종 회전 사원수 값은 [그림 14-14](#그림-14-14-구면으로-보간된-사원수와-직선으로-보간된-사원수의-비교)와 같이 계산될 것이다.

###### 그림 14-14 구면으로 보간된 사원수와 직선으로 보간된 사원수의 비교
![구면으로 보간된 사원수와 직선으로 보간된 사원수의 비교](/img/)

이를 만족시키는 선형 보간식의 두 계수 $\alpha$와 $\beta$값을 찾아야 한다.

###### 식 14-5

$$q' = \alpha \cdot q_1 + \beta \cdot q_2$$

[그림 14-15](#그림-14-15-구면으로-보간된-사원수를-평면의-벡터로-표현하기)와 같이 첫 번째 사원수를 $x$축에 일치시키고 이를 회전한 값을 구한다.        
첫 번째 사원수에 해당하는 벡터를 $\vec{x}$, 두 번째 사원수에 해당하는 벡터를 $\vec{u}$라고 할 때, $\vec{x}$에 직교하는 벡터를 $\vec{y}$로, 구해야 할 중간 사원수의 벡터를 $\vec{v}$로 정한다.

###### 그림 14-15 구면으로 보간된 사원수를 평면의 벡터로 표현하기
![구면으로 보간된 사원수를 평면의 벡터로 표현하기](/img/)

[식 14-5](#식-14-5)는 다음과 같이 벡터로 바꿔 쓸 수 있다.

###### 식 14-6

$$\vec{v} = \alpha \cdot \vec{x} + \beta \cdot \vec{u}$$

두 사원수가 만드는 각을 $\theta$라고 했을 때 우리가 구하려는 벡터 $\vec{v}$는 서로 직교하는 두 기저벡터 $\vec{x}$와 $\vec{y}$의 조합으로 계산된다.

###### 식 14-7

$$\vec{v} = \cos(t\theta) \vec{x} + \sin(t\theta) \vec{y}$$

앞에서 예로 든 비율 $\frac{1}{3}$에 대한 계산은 [그림 14-16](#그림-14-16-직교하는-두-기저벡터를-사용한-중간-벡터의-계산)과 같다.

###### 그림 14-16 직교하는 두 기저벡터를 사용한 중간 벡터의 계산
![직교하는 두 기저벡터를 사용한 중간 벡터의 계산](/img/)

벡터 $\vec{x}$에 직교하는 벡터 $\vec{y}$ 값을 모르므로 벡터 $\vec{u}$와 삼각함수를 활용해 이를 구해야 한다.     
[그림 14-17](#그림-14-17-두-번째-사원수로부터-직교하는-벡터-y-구하기)을 보면 $\vec{u} - \cos \theta \vec{x}$ 값과 $\sin \theta \cdot \vec{y}$ 값은 동일한 벡터를 가리킨다.

###### 그림 14-17 두 번째 사원수로부터 직교하는 벡터 y 구하기
![두 번째 사원수로부터 직교하는 벡터 y 구하기](/img/)

이를 활용하면 벡터 $\vec{y}$의 값은 다음과 같이 구할 수 있다.

$$\vec{y} = \frac{\vec{u} - \cos \theta \vec{x}}{\sin \theta}$$

이 값을 [식 14-7](#식-14-7)에 대입하면 최종 벡터를 구하는 식은 다음과 같이 전개된다.

$$
\begin{matrix}
\vec{v} &=& \cos(t\theta)\vec{x} + \sin(t\theta)(\frac{\vec{u} - \cos\theta\vec{x}}{\sin\theta}) \\
&=& (\frac{\sin\theta\cos(t\theta) - \cos\theta\sin(t\theta)}{\sin\theta})\vec{x} + \frac{\sin(t\theta)}{\sin\theta}\vec{u} \\
&=& \frac{\sin(\theta - t\theta)}{\sin \theta}\vec{x} + \frac{\sin(t\theta)}{\sin\theta}\vec{u} \\
\end{matrix}
$$

1. $\vec{x}$와 $\vec{u}$에 대해 묶는다.
2. $\vec{x}$의 계수는 삼각함수의 합 공식에 의해 간략히 정리된다.

위 식을 [식 14-6](#식-14-6)에 대입하면 찾아야 하는 두 계수 $\alpha$와 $\beta$는 각각 다음과 같다.

$$\alpha = \frac{\sin((1 - t)\theta)}{\sin\theta}$$

$$\beta = \frac{\sin(t\theta)}{\sin\theta}$$

위에서 구한 계수를 [식 14-5](#식-14-5)에 대입하면 구면으로 보간하는 최종 식이 만들어진다.

###### 식 14-8

$$q' = \frac{\sin((1-t)\theta)}{\sin \theta} \cdot q_1 + \frac{\sin(t\theta)}{\sin\theta} \cdot q_2$$

이 방법으로 보간하는 방법을 ***구면 선형 보간(Spherical linear interpolation)*** 이라고 하며, 줄여서 ***슬럽(Slerp)*** 이라 부른다.       
사원수의 구면 선형 보간을 구현하는 데 필요한 두 계수의 식 외에 고려할 점이 몇 가지 있다.        
먼저 ***두 사원수로부터 나오는 회전 경로는 항상 긴 경로와 짧은 경로의 두 가지가 있는데, 이 중에 하나를 선택***해야 한다는 점이다.     
[그림 14-18](#그림-14-18-두-벡터의-사잇각을-구하는-방법)과 같이 원 위에 벡터 $\vec{v_1}$와 벡터 $\vec{v_2}$가 있을 때 두 벡터가 만들어내는 회전 경로는 언제나 짧은 경로 $\theta_1$과 긴 경로 $\theta_2$ 두 가지가 존재한다.     
***일반적으로는 짧은 경로를 사용***한다.

###### 그림 14-18 두 벡터의 사잇각을 구하는 방법
![두 벡터의 사잇각을 구하는 방법](/img/)

[그림 14-18](#그림-14-18-두-벡터의-사잇각을-구하는-방법)의 경우 벡터 $\vec{v_1}$에서 벡터 $\vec{v_2}$로 순서대로 구면 선형 보간을 적용하면 짧은 경로에서의 보간이 진행된다.     
하지만 두 벡터가 [그림 14-19](#그림-14-19-벡터의-각이-긴-경로의-각으로-설정된-경우)와 같이 배치되어 있다면 구면 선형 보간은 긴 경로로 진행된다.

###### 그림 14-19 벡터의 각이 긴 경로의 각으로 설정된 경우
![벡터의 각이 긴 경로의 각으로 설정된 경우](/img/)

따라서 언제나 짧은 경로로 구면 선형 보간하고자 한다면, 구면 선형 보간을 진행하기 전에 두 벡터의 사잇각이 $180^\circ$보다 작은지부터 확인해야 한다.      
이보다 큰 경우에는 짧은 경로의 결과가 나오도록 계산 방법을 조정해야 한다.

두 벡터가 이루는 각을 조사하면 쉽게 해결 할 수 있지만, 현재 사용하는 사원수에는 항상 회전시키고자 하는 각의 절반이 저장되어 있기 때문에, 이를 감안해야 한다.        
예를 들어 사원수 $(0, (1, 0, 0))$에 대해 생각해보자.        
사원수 $(0, (1, 0, 0))$을 4차원 공간의 회전에 사용한다면 이는 $(\cos \theta, \sin \theta \vec{n})$로 해석되므로 $x$축을 중심으로 $90^\circ$로 회전 변환하는 회전 사원수가 된다.     
하지만 사원수 $(0, (1, 0, 0))$을 3차원 공간의 회전에 사용한다면 $(\cos \frac{\theta}{2}, \sin \frac{\theta}{2}\vec{n})$로 해석되어야 한다.      
이 경우에는 앞에서 살펴본 $v' = q \cdot v \cdot q^*$ 공식을 거쳐 3차원 공간에서 $x$축을 중심으로 하는 $180^\circ$ 회전 변환을 만들어낸다.       
[그림 14-20](#그림-14-20-사원수에-담긴-각의-정보)은 이에 관한 예시다.        
어떤 사원수에 저장된 각이 $120^\circ$라면, 해당 사원수를 통해 구현된 3차원 공간의 회전은 그 두 배인 $240^\circ$가 된다.

###### 그림 14-20 사원수에 담긴 각의 정보
![사원수에 담긴 각의 정보](/img/)

그렇기 때문에 긴 경로를 탐지하는 조건도 바뀐다.     
해당 경로가 긴 경로인지 여부를 탐지하기 위해 두 사원수가 이루는 사잇각은 $180^\circ$가 아닌 $90^\circ$가 되어야 한다.       
그렇다면 긴 경로인지 파악하기 위한 사잇각의 최소 크기는 $90^\circ$가 되며 이는 ***내적을 사용해 판별이 가능***하다.       
두 사원수의 내적 값이 음수가 나오면 두 사원수가 이루는 사잇각이 $90^\circ$보다 크다는 의미이며, 이는 긴 경로의 회전에 사원수가 사용된다고 판단할 수 있다.       
이 경우에는 두 번째 사원수를 짧은 경로의 사원수로 바꿔주어야 한다.

짧은 경로의 사원수는 사원수를 반전시키는 것으로 간단히 처리할 수 있다.      
예를 들어 두 사원수의 사잇각이 $120^\circ$인 경우, 실제 진행되는 $240^\circ$ 회전에 대응하는 짧은 경로의 회전은 $-120^\circ$ 회전이 된다.       
짧은 경로의 $-120^\circ$ 회전에 대응하는 사원수는 그 절반인 $-60^\circ$ 사잇각을 가진 사원수가 된다.        
이는 [그림 14-21](#그림-14-21-사원수를-반전시켜-짧은-거리의-사원수를-구하는-예시)과 같이 $120^\circ$ 사잇각을 가진 사원수 $q_2$를 반전해 얻을 수 있다.

###### 그림 14-21 사원수를 반전시켜 짧은 거리의 사원수를 구하는 예시
![사원수를 반전시켜 짧은 거리의 사원수를 구하는 예시](/img/)

구면 선형 보간을 구현할 때 고려할 점은 입력으로 들어온 두 사원수의 방향이 평행하면 분모 $\sin \theta$의 값이 0이 되어 [식 14-8](#식-14-8)의 구면 선형 보간 계산이 불가능해진다는 것이다.        
이 경우 긴 경로인지를 파악하기 위해 이미 계산했던 내적을 활용해 파악할 수 있다.     
내적 값의 크기가 1이면 두 사원수는 평행한 상태이기 때문이다.        
따라서 오차까지 감안해 두 사원수의 내적이 1과 매우 근접한 경우에는 일반 선형 보간을 사용하도록 로직을 만들어야 한다.

***구면 선형 보간은 카메라의 움직임이나 캐릭터 애니메이션과 같이 시간에 따른 부드러운 회전을 구현하는 데 유용하게 사용***된다.        